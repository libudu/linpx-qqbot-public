## 这是什么

这是LINPX的QQ机器人项目，称为linpx qqbot，主要提供小说查询、用户查询、每日小说和最近小说的查询及订阅、作者新发布小说订阅推送等功能。

此仓库为开源版，与线上实际版本有轻微差别（后面会详述），可能落后于线上版数个版本。

开源此项目仅为学习交流，如果意向开发类似linpx机器人的项目可以参考而不必从头做起，严禁用于商业用途。

了解node和oicq对本项目的理解会很有帮助。



## 主要功能

整体来说，linpx qqbot相当于为linpx提供基于qq消息的快速入口。主要功能都是基于既有的linpx后端数据接口，仅仅是将数据通过qq消息的形式进行发送展示。

1. 查询功能。包括查询作者、查询小说、查询每日小说、查询最近小说。
2. 订阅功能。用node-schedule做定时任务，用mongodb存储订阅群号和时间，轮询是否有群组订阅，有则发送相应内容。
3. 其他功能。一些简单的引导、帮助、提示、彩蛋等。




## 项目结构

作为im机器人项目，linpx qqbot主要包括以下三个部分。

1. 消息解析。从消息中去除消息头（此处主要为小小丢 ），提取出命令体以及命令参数（如果存在）。
2. 将命令体绑定到命令响应函数并传入解析出的命令参数。
3. 实现不同的命令相应函数。



/bot/index.ts：定义oicq的群聊和私聊整体框架，判断是否为有效命令（是否小小丢开头），提取出qq消息相关的必要信息（qq群号、发送者qq号、消息内容）等。

/bot/commands：定义命令关键字，连接命令的关键字和命令的响应函数。

/bot/linpx：linpx后端相关的命令响应函数的实现，以及封装linpx后端的请求和类型等。

/bot/subscribe：订阅相关的命令相应函数的实现，以及定时任务轮询。

/bot/private：与/bot/commands类似，不过是针对于私聊的命令配置。

/model：封装了mongodb的基本CRUD操作和l机器人业务相关的类型和接口。

/utils：一些通用的工具函数



此外，运行项目后，ociq框架将会生成/data目录，扫描其中的二维码即可登录（更多oicq框架相关的信息可查阅oicq的文档）。



## 不予公开的内容

1. 线上小小丢是我自己创建的QQ号不能公开使用，所以你需要新建一个QQ号（最好是两个，一个线上一个开发）。
2. 上述的订阅功能的实现需要使用mongodb数据库，所以需要自建一个mongodb数据库。
3. 最好能够搭建自己的linpx后端，使用linpx的线上后端也行，但是后面可能改动，并且会对线上造成一定压力。
4. 省略了一些管理员接口。



## 如何运行

1. 安装node、npm（或yarn）。

2. 克隆项目。

3. **配置/botconfig.ts中的一些数据项**。

   必须：qq号、mongodb数据库

   推荐：LINPX后端IP和前端IP和域名

   /botconfig.ts文件中有详细描述。

   ……

   在linpxconfig.ts文件中有详细描述。

4. 通过`npm install`或`yarn`命令安装依赖项。

5. 通过`npm start`运行项目。通过向自己的小号发送命令观察是否生效。

6. 通过`npm build`构建项目，将在/dist目录下生成编译后的js文件。



## 鸣谢

oicq：js的qq机器人框架

node：感谢能用javascript写后端

axios：很方便的请求库

node-schedule：node定时任务

typescript：类型系统yyds，化屎为神奇

mongodb：可以快速上手的数据库

uid：自动生成统一id

